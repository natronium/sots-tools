
<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  <title>SotS Save Decoder</title>
</head>

<body translate="no" >
  <p>submit your sots save file, and get a decoded copy + the ink state</p>
  <p>save file is located at:</p>
  <p><code>C:\Users\You\AppData\LocalLow\Echodog Games\Signs of the Sojourner/save.sots</code> on windows</p>
  <p><code>/home/You/Library/Application Support/Echodog Games/Signs of the Sojourner/save.sots</code> on mac</p>
  <p>(technically, submitting a decoded sots save (NOT THE INK STATE) should spit out a valid encoded save too)</p>
  <input type="file" id="fileInput">
  <br/>
  <a id="saveLink"></a>
  <br/>
  <a id="inkLink"></a>

  <script>
const inputElement = document.getElementById('fileInput');
inputElement.addEventListener('change', handleFiles, false);
function handleFiles() {
  const saveFile = this.files[0];
  saveFile.arrayBuffer().then(rawSaveBuffer => {

    const saveBuffer = new Uint8Array(rawSaveBuffer);
    decodedBuffer = xorCodec(saveBuffer);
    const save = JSON.parse(new TextDecoder().decode(decodedBuffer));

    const prettySaveString = JSON.stringify(save, null, 2);
    const prettyInkStateString = JSON.stringify(JSON.parse(save.inkState), null, 2);

    const saveFileName = `sots_decoded_save_${save.runId}.json`;
    saveBlobLink(
      'saveLink',
      new Blob([prettySaveString], {type: 'application/json'}),
      saveFileName,
      `Download ${saveFileName}`
    );

    const inkStateFileName = `sots_inkState_${save.runId}.json`;
    saveBlobLink(
      'inkLink',
      new Blob([prettyInkStateString], {type: 'application/json'}),
      inkStateFileName,
      `Download ${inkStateFileName} (this is part of the regular save, but this copy is in a more convenient shape for humans)`
    );

  });
}

function xorCodec(buffer){
  const key = 'wow this is a nice key';
  return buffer.map((e, i, arr) =>  e ^ key.charCodeAt(i % key.length));
}

function saveBlobLink(elementId, blob, filename, message){
  const link = document.getElementById(elementId);
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.text = message;
  return link; //in case we want to do something with it later, like click it
}
  </script>

</body>

</html>

